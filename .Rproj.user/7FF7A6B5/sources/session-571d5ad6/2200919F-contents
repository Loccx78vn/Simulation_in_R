---
title: "Gi·ªõi thi·ªáu"
subtitle: "Vi·ªát Nam, 2024"
author: "Cao Xu√¢n L·ªôc"
date: "2024-10-06"
number-sections: true
format: 
  html:
    code-fold: true
    code-tools: true
    theme: 
    - theme.scss
---

## Chu·∫©n b·ªã:

```{r}
#Call packages:
pacman::p_load(rio,
               here,
               janitor,
               tidyverse,
               dplyr,
               magrittr,
               lubridate,
               stringr
               )
```


D∆∞·ªõi ƒë√¢y l√† t·ªáp d·ªØ li·ªáu v·ªÅ nhu c·∫ßu c·ªßa kh√°ch h√†ng ·ªü 3 nh√† kho kh√°c nhau. B·∫°n c√≥ th·ªÉ nh·∫•n v√†o n√∫t d∆∞·ªõi ƒë√¢y ƒë·ªÉ t·∫£i v·ªÅ.

```{r}
#| warning: false
#| mesasge: false
#| echo: false
library(readxl)
df<-read_excel("Data.xlsx")

library(downloadthis)
df %>%
  download_this(
    output_name = "product_demand",
    output_extension = ".csv",
    button_label = "Download data",
    button_type = "warning",
    has_icon = TRUE,
    icon = "fa fa-save"
  )
```
## L·∫≠p k·∫ø ho·∫°ch MRP:

### D·ª± ƒëo√°n nhu c·∫ßu:

Sau khi ƒë√£ c√≥ d·ªØ li·ªáu, ch√∫ng ta s·∫Ω b·∫Øt ƒë·∫ßu d·ª± ƒëo√°n nhu c·∫ßu c·ªßa kh√°ch h√†ng d·ª±a v√†o d·ªØ li·ªáu trong qu√° kh·ª© b·∫±ng th∆∞ vi·ªán `modeltime`. M√¨nh ƒë√£ t·ª´ng vi·∫øt 1 b√†i h∆∞·ªõng d·∫´n c√°ch s·ª≠ d·ª•ng th∆∞ vi·ªán n√†y ·ªü b√†i vi·∫øt [Time series model 2](https://loccx78vn.github.io/Forecasting_time_series_2/Time_series_2.html), b·∫°n c√≥ th·ªÉ xem qua.

```{r}
#| warning: false
#| mesasge: false
library(timetk)
demand<-df %>% 
    pivot_longer(cols = c(WHA,WHB,WHC), 
               names_to = "WH", 
               values_to = "Sale")
  
p<-demand %>% 
  group_by(WH) %>% 
  plot_time_series(Date, 
                   Sale, 
                   .interactive = T,
                   .color_var = month(Date))

#| warning: false
#| message: false
library(parsnip)
library(rsample)
# Devide the dataset to 7:3
splits <- initial_time_split(demand, prop = 0.7)
# ---- AUTO ARIMA ----

library(modeltime)
# Model Spec
model_spec <- arima_reg() %>%
    set_engine("auto_arima")

# Fit model:
model_fit <- model_spec %>%
    fit(Sale ~ Date, 
        data = training(splits))

# Evaluate the model:
invisible(capture.output({
modeltime_tbl <- modeltime_table(
    model_fit
) 
k<-modeltime_tbl %>%
    modeltime_calibrate(testing(splits)) %>%
    modeltime_forecast(
      new_data    = testing(splits),
      actual_data = demand,
      keep_data   = TRUE
    )
}))
```

M√¥ h√¨nh ƒë∆∞a ra c√≥ v·∫ª kh√° t·ªët v√¨ sai s·ªë trung b√¨nh ch·ªâ ·ªü m·ª©c 5% ƒë·ªëi v·ªõi nh√† kho A v√† C, nh√† kho B th√¨ t·ªá h∆°n m·ªôt ch√∫t v·ªõi m·ª©c 10%.

::: panel-tabset

## Plot:

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-cap: "B·∫£ng 2: D·ª± ƒëo√°n d·ªØ li·ªáu b·∫±ng package `modeltime`"
## Plot the result:
forecast_plot<-plot_modeltime_forecast(k %>% 
        group_by(WH),
        .interactive = T)

library(plotly)
forecast_plot %>% 
  layout(
    legend = list(
      x = 0.5,  # Centered horizontally
      y = -0.2,  # Position below the plot area
      xanchor = "center",  # Anchor to the center
      yanchor = "top"      # Anchor the top of the legend to the specified Y position
    )
  )
```

## Table:

```{r}
#| echo: false
#| warning: false
#| message: false
#| nrow: 2
#| fig-cap: "B·∫£ng 3: ƒê√°nh gi√° m·ª©c ƒë·ªô d·ª± ƒëo√°n c·ªßa m√¥ h√¨nh"
## Create table:
n<-k %>% filter(.model_desc =="ARIMA(0,0,0)(2,0,1)[7] WITH NON-ZERO MEAN")
m<-data.frame(Date = as.Date(n$Date),
              WH = n$WH,
              Predicted = round(n$.value,2),
              Observed = testing(splits)$Sale) %>% 
  mutate(Per_error = round(abs(Predicted - Observed) / Observed, 2),
         Check = ifelse(Per_error < 0.05, "Pass","Fail"))

# Summary calculations
summary_data <- m %>%
  group_by(WH) %>% 
  summarize(
    Total_Observed = n(),
    Mean_Percentage_Error = round(mean(Per_error),4),
    Median_Percentage_Error = round(median(Per_error),4),
    Count_Pass = sum(Check == "Pass"),
    Count_Fail = sum(Check == "Fail")
  )

library(gt)
library(gtExtras)
gt_table <- summary_data %>%
  gt() %>%
  tab_header(
    title = md("**Summary Statistics**"),
    subtitle = md("*Source: package gt in R*")
  ) %>%
  cols_label(
    Total_Observed = "Observation",
    Mean_Percentage_Error = "Mean error (%)",
    Median_Percentage_Error = "Median error (%)",
    Count_Pass = "Total pass",
    Count_Fail = "Total fail"
  ) %>%
   cols_align(
    align = "center",
    columns = everything()
  ) %>% 
  gt_theme_pff() %>% 
  tab_options(
    table.width = "80%"
  )

# Display the gt table
gt_table

library(reactable)
# Create an interactive table using reactable
reactable(m,
          columns = list(
            Date = colDef(name = "Date", 
                           sortable = TRUE, 
                           align = "center", 
                           headerStyle = list(background = "#b0b0b0")),  # Darker gray header
            WH = colDef(name = "Warehouse", 
                           sortable = TRUE, 
                           align = "center", 
                           headerStyle = list(background = "#b0b0b0")),  # Darker gray header
            Predicted = colDef(name = "Predicted", 
                               align = "center", 
                               headerStyle = list(background = "#b0b0b0")),  # Darker gray header
            Observed = colDef(name = "Observed", 
                              align = "center", 
                              headerStyle = list(background = "#b0b0b0")),  # Darker gray header
            Per_error = colDef(name = "Percentage Error (%)", 
                               format = colFormat(percent = TRUE),
                               align = "center", 
                               headerStyle = list(background = "#b0b0b0"),  # Darker gray header
                               style = function(value) {
                                 color <- ifelse(value > 0.05, "#e00000", "#008000")  # Red if > 5%, green if <= 5%
                                 list(color = color, fontWeight = "bold")
                               }),
            Check = colDef(name = "Status", 
                           align = "center",
                           headerStyle = list(background = "#b0b0b0"),  # Darker gray header
                           cell = function(value) {
                             style <- ifelse(value == "Pass", 
                                             "background-color: green; color: white;",
                                             "background-color: red; color: white;")  # Red for Fail
                             htmltools::tags$div(value, style = style)
                           })
          ),
          defaultPageSize = 10,
          highlight = TRUE,
          striped = TRUE,
          bordered = TRUE,
          resizable = TRUE
)
```
:::

V·∫≠y ch√∫ng ta ƒë√£ c√≥ d·ªØ li·ªáu ƒë·∫ßu v√†o l√† d·ª± ƒëo√°n nhu c·∫ßu. Ti·∫øp theo, ta s·∫Ω x√¢y d·ª±ng k·∫ø ho·∫°ch cung ·ª©ng h√†ng h√≥a d·ª±a tr√™n k·∫øt qu·∫£ tr√™n. **K·∫ø ho·∫°ch cung ·ª©ng** nghƒ©a nh·∫±m ƒë·∫£m b·∫£o r·∫±ng h√†ng h√≥a v√† d·ªãch v·ª• ƒë∆∞·ª£c cung c·∫•p ƒë√∫ng th·ªùi ƒëi·ªÉm, ƒë√∫ng s·ªë l∆∞·ª£ng v√† v·ªõi chi ph√≠ h·ª£p l√Ω.

Th√¥ng th∆∞·ªùng, k·∫ø ho·∫°ch cung ·ª©ng ch·ªâ g·ªìm **4 th√¥ng tin** ƒë∆°n gi·∫£n l√†:

- ƒê·ªãa ƒëi·ªÉm b·ªëc h√†ng.
- ƒê·ªãa ƒëi·ªÉm giao h√†ng.
- Lo·∫°i h√†ng h√≥a.
- S·ªë l∆∞·ª£ng h√†ng.

V√† k·∫ø ho·∫°ch c√≥ th·ªÉ theo ng√†y ƒë·ªëi v·ªõi c√°c c·ª≠a h√†ng b√°ch h√≥a, si√™u th·ªã ho·∫∑c theo tu·∫ßn ƒë·ªëi v·ªõi c√°c nh√† kho. Ngo√†i ra, c√≤n t√πy v√†o m·∫∑t h√†ng l√† h√†ng h√≥a g√¨, nhu c·∫ßu c·ªßa h√†ng h√≥a nh∆∞ th·ªÉ n√†o c≈©ng ·∫£nh h∆∞·ªüng ƒë·∫øn th·ªùi gian giao h√†ng nh∆∞: h√†ng b√°n ch·∫°y th√¨ c·∫ßn cung ·ª©ng h·∫±ng ng√†y, h√†ng ·∫ø ·∫©m th√¨ c√≥ khi c·∫£ th√°ng m·ªõi nh·∫≠p ho·∫∑c xu·∫•t m·ªôt l·∫ßn.

Nh∆∞ v·∫≠y, ta c·∫ßn x√°c ƒë·ªãnh khi n√†o h√†ng s·∫Ω c√≥ nguy c∆° b·ªã *outstock* ƒë·ªÉ l·∫≠p k·∫ø ho·∫°ch cung ·ª©ng cho kho·∫£ng th·ªùi gian l√† 1 th√°ng ti·∫øp theo.

### C√°c th√¥ng s·ªë c·ªßa nh√† kho:

M·ªói nh√† kho s·∫Ω c√≥ c√°c th√¥ng s·ªë ƒë√°nh gi√° kh√°c nhau. ƒê·ªëi v·ªõi nh√† kho thu·ªôc d·∫°ng *public warehouse* th√¨ h·ªç quan t√¢m v·ªÅ m·ª©c ƒë·ªô l·∫•p ƒë·∫ßy ch·ªó (gi·ªëng nh∆∞ mua v√© xem phim v·∫≠y, c√†ng √≠t ch·ªó tr·ªëng nghƒ©a l√† doanh thu cao), *private warehouse* th√¨ th∆∞·ªùng s·∫Ω quan t√¢m ƒë·∫øn c√°c d·ªãch v·ª• cao c·∫•p h∆°n nh∆∞: kho l·∫°nh, ph√≤ng ch√°y ch·ªØa ch√°y, d·∫°ng *cross-docking* th√¨ ƒë·∫∑c bi·ªát quan t√¢m ƒë·∫øn t·ªëc ƒë·ªô chu chuy·ªÉn h√†ng h√≥a trong kho,... Nh∆∞ng v·ªÅ t·ªïng quan, ƒë·ªÉ qu·∫£n l√≠ h√†ng h√≥a trong kho s·∫Ω c·∫ßn c√°c th√¥ng s·ªë nh∆∞:

- *Mean of demand*: nhu c·∫ßu trung b√¨nh theo ng√†y/th√°ng/nƒÉm c·ªßa s·∫£n ph·∫©m.

- *Standard deviation of demand*: ph∆∞∆°ng sai c·ªßa s·∫£n ph·∫©m.

- *Safety stock* v√† *Lead time*.

ƒê·∫ßu ti√™n, ta s·∫Ω t√≠nh c√°c gi√° tr·ªã *Lead time* v√† *Safety stock* cho t·ª´ng nh√† kho.

```{r}
#| fig-cap: "B·∫£ng 4: C√°c th√¥ng s·ªë ƒë√°nh gi√° c·ªßa t·ª´ng nh√† kho"
library(dplyr)
library(knitr)

safety_stock_tbl <- k %>%
  group_by(WH) %>%
  summarise(Mean = round(mean(.value),0),
            SD = sd(.value)) %>%
  mutate(Leadtime = c("2 days", "1.5 days", "2.5 days"),
         Safety_stock = round(1.64 * SD * sqrt(as.numeric(sub(" days", "", Leadtime))),0),
         ROP = Mean * as.numeric(sub(" days", "", Leadtime)) + Safety_stock)

safety_stock_tbl %>%
  gt() %>%
  tab_header(
    title = md("**Safety Stock by Warehouse**"),
    subtitle = md("*Source: package gt in R*")
  ) %>%
  cols_label(
    WH = "Warehouse",
    Mean = "Mean",
    SD = "Standard Deviation",
    Leadtime = "Lead Time",
    Safety_stock = "Safety Stock",
    ROP = "Reorder Point"
  ) %>% tab_style(
    style = list(
      cell_text(align = "center")
    ),
    locations = cells_body(columns = everything())
  ) %>%
   cols_align(
    align = "center",
    columns = everything()
  ) %>% 
  gt_theme_pff() %>% 
  tab_options(
    table.width = "80%"
  )
```

Sau khi ƒë√£ c√≥ c√°c th√¥ng s·ªë c·∫ßn thi·∫øt, ch√∫ng ta s·∫Ω b·∫Øt ƒë·∫ßu b∆∞·ªõc **simulation - gi·∫£ l·∫≠p** cho s·ªë l∆∞·ª£ng h√†ng t·ªìn kho trong g·∫ßn 1 th√°ng ti·∫øp theo. ·ªû ƒë√¢y m√¨nh s·∫Ω x√¢y d·ª±ng k·∫ø ho·∫°ch cho nh√† kho *B*. Trong ƒë√≥, h√†m d∆∞·ªõi ƒë√¢y m√¨nh vi·∫øt gi√∫p b·∫°n c√≥ th·ªÉ t√≠nh to√°n cho nhi·ªÅu tr∆∞·ªùng h·ª£p v·ªõi 4 ƒë·ªëi s·ªë:

- *M√£ nh√† kho*: trong b·ªô d·ªØ li·ªáu n√†y s·∫Ω c√≥ 3 nh√† kho v·ªõi c√°c m√£: "WHA", "WHB", "WHC". ·ªû ƒë√¢y, m√¨nh ƒë·∫∑t `warehouse = "WHB"`.

- *Batch order*: l√† s·ªë l∆∞·ª£ng h√†ng ƒë·∫∑t t·ª´ *supplier*. T√πy v√†o ƒë·∫∑c t√≠nh c·ªßa s·∫£n ph·∫©m, s·ªë l∆∞·ª£ng ƒë·∫∑t h√†ng c√≥ th·ªÉ ch√™nh l·ªách so v·ªõi s·ªë l∆∞·ª£ng m√† b·∫°n c·∫ßn. V√≠ d·ª•, b·∫°n ch·ªâ c·∫ßn 450 t·∫•n l√† v·ª´a ƒë·ªß nh∆∞ng 1 l√¥ h√†ng m√† nh√† cung c·∫•p s·∫£n xu·∫•t s·∫Ω l√† 500 t·∫•n (quy m√¥ th·∫•p h∆°n th√¨ chi ph√≠/bao s·∫Ω cao h∆°n) n√™n b·∫°n ch·ªâ c√≥ th·ªÉ ƒë·∫∑t 500 t·∫•n ch·ª© ƒë·∫∑t 450 th√¨ 2 b√™n s·∫Ω kh√¥ng th·ªèa thu·∫≠n ƒë∆∞·ª£c. ·ªû ƒë√¢y m√¨nh ƒë·∫∑t `quantity = 600`.

- *Leadtime*: kh√°i ni·ªám n√†y m√¨nh c≈©ng ƒë·ªÅ c·∫≠p ·ªü tr√™n nh∆∞ng ·ªü ƒë√¢y b·∫°n c√≥ th·ªÉ c√¢n nh·∫Øc vi·ªác c·ªông th√™m 1 kho·∫£ng *safety leadtime* ƒë·ªÉ n√¢ng cao hi·ªáu qu·∫£ c√¥ng vi·ªác. V√≠ d·ª•, leadtime c·ªßa nh√† kho *C* l√† 2.5 ng√†y th√¨ m√¨nh c√≥ th·ªÉ ƒë·∫∑t h√†ng s·ªõm tr∆∞·ªõc 1 ng√†y so v·ªõi ng√†y d·ª± ki·∫øn *ROP*.

- *Starting inventory*: l∆∞·ª£ng h√†ng t·ªìn kho ƒë·∫ßu k√¨. ·ªû ƒë√¢y m√¨nh ƒë·∫∑t `inv_start = 500`.

```{r}
long_df<-df %>% 
  pivot_longer(cols = contains("WH"),
               names_to = "Warehouse",
               values_to = "Demand")

f<-function(warehouse,quantity,leadtime,inv_start){

## Inpur:
batch_order <- quantity
safetystock <- safety_stock_tbl %>%
  filter(WH == warehouse) %>%
  select(ROP) %>%
  pull()

mrp<-long_df %>% 
  filter(Date >= as.Date("2024-06-02") & Warehouse == warehouse) %>%
  select(c(Date, Demand)) %>% 
  mutate(Inv_start= NA,
         Inv_end = NA,
         ROP = NA,
         Stockout = NA)

mrp$Inv_start[1]<-inv_start
mrp$Inv_end[1] <-mrp$Inv_start[1]-mrp$Demand[1]

## Processing:
reorder_goods <- function(data, 
                          safety_stock = safetystock, 
                          lead_time = leadtime, 
                          batch_order = quantity) {
  data$ROP <- 0
  last_reorder_day <- -(leadtime + 1)  # Initialize to a value that allows immediate reorder

  for (day in 1:nrow(data)) {
    # Check if we can place a new order (ROP = 1)
    if (!is.na(data$Inv_end[day]) && 
        data$Inv_end[day] < safety_stock && 
        (day - last_reorder_day > leadtime)) {  # Ensure at least 2 days since last reorder
      data$ROP[day] <- 1
      last_reorder_day <- day  # Update the last reorder day

      reorder_day <- day + lead_time

      if (reorder_day <= nrow(data)) {
        data$Inv_end[reorder_day] <- ifelse(is.na(data$Inv_end[reorder_day]), 0, data$Inv_end[reorder_day]) + batch_order
        
        for (i in (reorder_day+1):nrow(data)) {
          data$Inv_start[i] <- data$Inv_end[i - 1]
          data$Inv_end[i] <- data$Inv_start[i] - data$Demand[i]
        }
      }
    }
    
   # Assign Stockout status

  }
  
  return(data)
}


# Fill in Inv_end for the rest of the days
for (i in 2:nrow(mrp)) {
  mrp$Inv_start[i] <- mrp$Inv_end[i - 1]
  mrp$Inv_end[i] <- mrp$Inv_start[i] - mrp$Demand[i]
}

# Apply the reorder function
result <- reorder_goods(mrp)

for (i in 1:nrow(result)){
  result$Stockout[i] <- ifelse(result$Inv_start[i] < result$Demand[i], 1, 0)
}
return(result)
}

result<-f("WHB",600,3,500)
```

K·∫øt qu·∫£ gi·∫£ l·∫≠p ƒë∆∞·ª£c tr√¨nh b√†y nh∆∞ sau, trong ƒë√≥:

- *Starting inv*: l√† t·ªìn kho ƒë·∫ßu ng√†y (ho·∫∑c ƒë·∫ßu k√¨ cho th√°ng/nƒÉm). L∆∞·ª£ng h√†ng ƒë·∫ßu ng√†y s·∫Ω b·∫±ng l∆∞·ª£ng h√†ng cu·ªëi ng√†y h√¥m tr∆∞·ªõc.
- *Ending inv*: l√† t·ªìn kho cu·ªëi ng√†y, ƒë∆∞·ª£c t√≠nh b·∫±ng hi·ªáu s·ªë c·ªßa l∆∞·ª£ng h√†ng ƒë·∫ßu ng√†y v√† nhu c·∫ßu c·ªßa kh√°ch h√†ng.
- *Status*: √°m ch·ªâ tr·∫°ng th√°i c·ªßa nh√† kho, ·ªü ƒë√¢y c√≥ 3 d·∫°ng tr·∫°ng th√°i: *Oke* l√† khi nh√† kho kh√¥ng b·ªã *outstock* v√† kh√¥ng c·∫ßn ƒë·∫∑t th√™m h√†ng, *Reorder* khi ƒë·∫∑t ƒë∆°n h√†ng v√† *Outstock* khi l∆∞·ª£ng h√†ng t·ªìn kho kh√¥ng ƒë·ªß ƒë·ªÉ ph·ª•c v·ª• nhu c·∫ßu c·ªßa kh√°ch h√†ng v√†o ng√†y ƒë√≥.
- *Supply*: l∆∞·ª£ng h√†ng s·∫Ω nh·∫≠n t·ª´ ƒë∆°n ƒë·∫∑t h√†ng.

```{r}
#| warning: false
#| message: false
#| fig-cap: "B·∫£ng 5: K·∫øt qu·∫£ gi·∫£ l·∫≠p c·ªßa k·∫ø ho·∫°ch MRP"
library(reactable)
library(reactablefmtr)
library(htmltools)

# create a function status.PI.Index
status_PI.Index <- function(color = "#aaa", width = "0.55rem", height = width) {
  span(style = list(
    display = "inline-block",
    marginRight = "0.5rem",
    width = width,
    height = height,
    backgroundColor = color,
    borderRadius = "50%"
  ))
}
# Reactable:
table<-result %>% 
            mutate(Date = as.Date(Date),
                   Status = ifelse(ROP == 0 & Stockout == 0, "Oke",
                                   ifelse(ROP == 1  & Stockout == 0, "Reorder","Overstock")),
                   Supply = ROP*600) %>% 
                     select(-c(ROP,Stockout))

reactable(table,
  columns = list(
    Date = colDef(name = "Date", 
                   sortable = TRUE, 
                   align = "center", 
                   headerStyle = list(background = "#b0b0b0")),  
    Demand = colDef(name = "Demand", 
                    align = "center", 
                    headerStyle = list(background = "#b0b0b0"),
                    cell = data_bars(table, 
                               fill_color = "#3fc1c5",
                               text_position = "outside-end")
            ),  
    Inv_start = colDef(name = "Starting Inv", 
                       align = "center", 
                       headerStyle = list(background = "#b0b0b0"),
                       style = function(value) {
                         color <- ifelse(value <= 0, "#e00000", "#008000")  
                         list(color = color, fontWeight = "bold")
                       }),
    Supply = colDef(name = "Supply (units)",
                    align = "center",
                    headerStyle = list(background = "#b0b0b0"),
                    cell = data_bars(table, 
                               fill_color = "#3CB371",
                               text_position = "outside-end")
            ),
    Inv_end = colDef(name = "Ending Inv", 
                     align = "center", 
                     headerStyle = list(background = "#b0b0b0"),
                     style = function(value) {
                       color <- ifelse(value <= 0, "#e00000", "#008000")  
                       list(color = color, fontWeight = "bold")
                     }),
    Status = colDef(
              name = "Status",
                     headerStyle = list(background = "#b0b0b0"),
              cell = function(value) {
                color <- switch(value,
                                Overstock = "hsl(3, 69%, 50%)",
                                Oke = "hsl(154, 64%, 50%)",
                                Reorder = "hsl(214, 45%, 50%)")
                Status <- status_PI.Index(color = color)
                tagList(Status, value)
              }
            )),
  defaultPageSize = 10,
  highlight = TRUE,
  striped = TRUE,
  bordered = TRUE,
  resizable = TRUE
)
```

### Th√™m safety leadtime:

B√¢y gi·ªù ch√∫ng ta ƒë√£ c√≥ k·∫ø ho·∫°ch d·ª± ki·∫øn trong th√°ng ti·∫øp theo gi·ªëng ta ƒë√£ bi·∫øt tr∆∞·ªõc ƒë∆∞·ª£c khi n√†o th√¨ nh√† kho s·∫Ω b·ªã outstock v√† d·ª±a v√†o ƒë√≥, ta c√≥ th·ªÉ ƒë∆∞a ra ph∆∞∆°ng √°n ƒë·ªÉ tr√°nh vi·ªác n√†y. 

Nh∆∞ trong tr∆∞·ªùng h·ª£p n√†y, nh√† kho **B** b·ªã outstock t·ªõi t·∫≠n **16** l·∫≠n, m·ªôt con s·ªë kh√° t·ªá. L√† ng∆∞·ªùi qu·∫£n l√≠ kho, ta s·∫Ω ƒë∆∞a ra ph∆∞∆°ng √°n l√† ƒë·∫∑t h√†ng tr∆∞·ªõc 1 ng√†y d·ª± ki·∫øn m√† l∆∞·ª£ng h√†ng t·ªìn kho nh·ªè h∆°n *safety stock*.

#### So s√°nh gi·ªØa 2 c√°ch:

**K·∫øt qu·∫£:** Qua bi·ªÉu ƒë·ªì d∆∞·ªõi ƒë√¢y, ta c≈©ng d·ªÖ d√†ng th·∫•y l√† vi·ªác ƒë·∫∑t h√†ng **tr∆∞·ªõc 1 ng√†y** h√†ng t·ªìn kho nh·ªè h∆°n *safety stock* gi·∫£m t√¨nh tr·∫°ng *outstock* ƒë√°ng k·ªÉ (t·ª´ **16** l·∫ßn xu·ªëng c√≤n **6** l·∫ßn trong th√°ng). 

Ngo√†i ra, m·ªôt ƒëi·ªÉm ƒë·∫∑c bi·ªát l√† kh√¥ng x·∫£y ra **t√¨nh tr·∫°ng n·ª£ h√†ng**, nghƒ©a l√† c·ª≠a h√†ng c·ªßa b·∫°n ch·ªâ b·ªã thi·∫øu h√†ng v√† ch∆∞a ƒë·ªß th·ªèa m√£n h·∫øt nhu c·∫ßu trong ng√†y c·ªßa kh√°ch h√†ng ch·ªõ kh√¥ng b·ªã √¢m h√†ng nh∆∞ c√°ch c≈©.

```{r}
#| echo: false
#| fig-cap: "B·∫£ng 6: So s√°nh gi·ªØa ph∆∞∆°ng ph√°p truy·ªÅn th·ªëng v√† th√™m safety leadtime"
result <- read_excel("my_data.xlsx")

compare<-result %>% 
            mutate(Date = as.Date(Date),
                   Fulfill = ifelse(Inv_start/Demand < 1,round(Inv_start/Demand,3),1),
                   Fulfill_safety = ifelse(Inv_start_safety/Demand < 1, round(Inv_start_safety/Demand,3),1)) %>% 
  select (c(Fulfill,
            Stockout,
            Fulfill_safety,
            Stock_out_safety)) 
                   
library(reactablefmtr)             
compare %>% 
reactable(
  columns = list(
     Fulfill = colDef(
      name = "Normal fulfill",
      cell = data_bars(., 
                       fill_color = c("#F44336","#4CAF50"),
                       text_position = "inside-end", 
                       number_fmt = scales::percent)),
     Fulfill_safety = colDef(
      name = "Safety fulfill",
      cell = data_bars(., 
                       fill_color =  c("#b0f1a6","#4CAF50"),
                       text_position = "inside-end", 
                       number_fmt = scales::percent)),
    Stock_out_safety = colDef(
      name = "Safety Stockout",
      align = "center",
      cell = function(value) {
        if (value == "0") {
          htmltools::tags$span("‚úîÔ∏è", style = "color: green; font-size: 18px;")  # Checkmark
        } else {
          htmltools::tags$span("‚ùå", style = "color: gray; font-size: 18px;")  # Cross
        }
      }
    ),
    Stockout = colDef(
      align = "center",
      cell = function(value) {
        if (value == "0") {
          htmltools::tags$span("‚úîÔ∏è", style = "color: green; font-size: 18px;")  # Checkmark
        } else {
          htmltools::tags$span("‚ùå", style = "color: gray; font-size: 18px;")  # Cross
        }
      }
    )
  ),
  defaultPageSize = 5,
  highlight = TRUE,
  striped = TRUE,
  bordered = TRUE,
  resizable = TRUE
)
```

#### ƒê√°nh gi√° b·∫±ng line chart:

ƒê·ªÉ so s√°nh s·ª± quan tr·ªçng c·ªßa *safety leadtime*, m√¨nh s·∫Ω s·ª≠ d·ª•ng *line chart* ƒë·ªÉ ƒë√°nh gi√° m·ª©c ƒë·ªô d·ªãch v·ª• c·ªßa nh√† kho d·ª±a tr√™n ti√™u ch√≠ *high service*: c√†ng √≠t *outstock* th√¨ c√†ng t·ªët. Ngo√†i ra, m√¨nh c√≤n th√™m v√†o c√°c ƒë∆∞·ªùng n√©t ƒë·ª©t bi·ªÉu di·ªÖn th·ªùi ƒëi·ªÉm ROP

```{r}
#| warning: false
#| message: false
#| fig-cap: "B·∫£ng 7: So s√°nh level of service c·ªßa hai ph∆∞∆°ng ph√°p"
# Create time series objects with daily frequency
library(xts)
demand_ts <-xts(result$Demand, 
                order.by = result$Date)
inv_start_ts <- xts(result$Inv_start, 
                   order.by = result$Date)
inv_start_safety_ts <- xts(result$Inv_start_safety,
                           order.by = result$Date)

event<-result %>% 
  filter(ROP == 1) %>% 
  select(Date) %>% 
  mutate(Date = as.Date(Date)) %>% 
  pull()

# Create line plot:
library(dygraphs)
combine <- cbind(demand_ts,
                 inv_start_ts,
                 inv_start_safety_ts)

dygraph(combine) %>%
  dySeries("demand_ts", label = "Demand") %>%
  dySeries("inv_start_ts", label = "Starting inv") %>% 
  dySeries("inv_start_safety_ts", label = "Starting safety inv") %>% 
  dyOptions(fillGraph = TRUE, fillAlpha = 0.4) %>% 
  dyEvent(event[1], "ROP", labelLoc = "bottom") %>%
  dyEvent(event[2], "ROP", labelLoc = "bottom") %>%
  dyEvent(event[3], "ROP", labelLoc = "bottom") %>%
  dyEvent(event[4], "ROP", labelLoc = "bottom") %>%
  dyEvent(event[5], "ROP", labelLoc = "bottom") %>%
  dyEvent(event[6], "ROP", labelLoc = "bottom")
```

Tuy nhi√™n n·∫øu x√©t v·ªÅ ti√™u ch√≠ t·ªëi ∆∞u chi ph√≠ (*saving cost*) th√¨ ta c·∫ßn t√≠nh to√°n th√™m chi ph√≠ c·ªßa vi·ªác *outstock* v√† chi ph√≠ t·ªìn kho (*inventory cost*).

Gi·∫£ s·ª≠ chi ph√≠ c·ªßa *inventory cost* l√† \$40/s·∫£n ph·∫©m v√† *outstock cost* l√† 15`$`/s·∫£n ph·∫©m th√¨ ta s·∫Ω c√≥ b·∫£ng so s√°nh nh∆∞ b·∫£ng d∆∞·ªõi ƒë√¢y. K·∫øt qu·∫£ cho th·∫•y ph∆∞∆°ng ph√°p truy·ªÅn th·ªëng gi√∫p chi ph√≠ ·ªü m·ª©c th·∫•p h∆°n. 

```{r}
#| fig-cap: "B·∫£ng 8: So s√°nh t·ªïng chi ph√≠ gi·ªØa hai ph∆∞∆°ng ph√°p"
library(gt)
library(gtExtras)
gt(result %>% 
  summarise(`Normal` = sum(Stockout),
            `Safety Leadtime` = sum(Stock_out_safety)) %>% 
  pivot_longer(cols = everything(),
               names_to = "Approach",
               values_to = "Outstock cost") %>% 
  mutate(`Outstock cost` = `Outstock cost` * 30,
         `Inventory cost` = c(result$Inv_end[nrow(result)],
                              result$Inv_end_safety[nrow(result)])
  ) %>% 
  mutate(`Inventory cost` = ifelse(`Inventory cost` < 0,0,`Inventory cost`*15),
         Total = `Outstock cost` + `Inventory cost`))  %>%
  tab_header(
    title = "Inventory and Stockout Costs"
  ) %>%
  cols_label(
    Approach = "Approach",
    `Outstock cost` = "Outstock Cost ($)",
    `Inventory cost` = "Inventory Cost ($)"
  ) %>%
  fmt_currency(
    columns = c(`Outstock cost`, `Inventory cost`, Total),
    currency = "USD"
  ) %>% 
  gt_highlight_rows(
     rows = 2,
     fill = "orange",
     bold_target_only = TRUE,
     target_col = Total
   )  %>%
   cols_align(
    align = "center",
    columns = everything()
  ) %>% 
  gt_theme_pff() %>% 
  tab_options(
    table.width = "80%"
  )
```

## K·∫øt lu·∫≠n:

Nh∆∞ v·∫≠y, ·ªü b√†i post n√†y ch√∫ng ta ƒë√£ h·ªçc ƒë∆∞·ª£c c√°ch s·ª≠ d·ª•ng R trong vi·ªác x√¢y d·ª±ng k·∫ø ho·∫°ch **MRP** d·ª±a v√†o d·ªØ li·ªáu qu√° kh·ª© c≈©ng nh∆∞ so s√°nh k·∫øt qu·∫£ gi·ªØa 2 ti√™u ch√≠ l√†: *high service* v√† *low cost*.

Ti·∫øp theo, ta l·∫°i ti·∫øp t·ª•c quy tr√¨nh tr√™n v√† l√†m k·∫ø ho·∫°ch cho c√°c th√°ng sau.

```{r}
#| warning: false
#| message: false
#| fig-cap: "B·∫£ng 9: K·∫øt qu·∫£ d·ª± ƒëo√°n nhu c·∫ßu trong 1 th√°ng ti·∫øp theo"
## G·ªôp d·ªØ li·ªáu t·ª´ training set v√† testing set th√†nh m·ªôt:
data_prepared_tbl <- bind_rows(training(splits), 
                               testing(splits))


## T·∫°o th√™m c√°c h√†ng cho d·ªØ li·ªáu s·∫Øp t·ªõi. V√≠ d·ª• ta c·∫ßn trong 6 th√°ng th√¨ h√†m s·∫Ω t·∫°o th√™m 365*4 = 1460 h√†ng:
future_tbl <- data_prepared_tbl %>%
    group_by(WH) %>%
    future_frame(.length_out = "1 months") %>%
    ungroup()

## D·ª± ƒëo√°n nhu c·∫ßu cho 3 th√°ng ti·∫øp theo:
refit_tbl <- modeltime_tbl %>%
    modeltime_refit(data_prepared_tbl)

invisible(capture.output({
refit_tbl<-refit_tbl %>%
    modeltime_forecast(
        new_data    = future_tbl,
        actual_data = data_prepared_tbl,
        keep_data   = TRUE) 
}))

refit_tbl %>% 
  group_by(WH) %>% 
  plot_modeltime_forecast(
         .interactive = TRUE) %>% 
  layout(
    legend = list(
      x = 0.5,  # Centered horizontally
      y = -0.2,  # Position below the plot area
      xanchor = "center",  # Anchor to the center
      yanchor = "top"      # Anchor the top of the legend to the specified Y position
    )
  )
```


Nh∆∞ v·∫≠y, ch√∫ng ta ƒë√£ ƒë∆∞·ª£c h·ªçc v·ªÅ thu·∫≠t to√°n Genetic v√† m√¥ h√¨nh MILP c≈©ng nh∆∞ c√°ch th·ª±c hi·ªán trong Rstudio. 

N·∫øu b·∫°n c√≥ c√¢u h·ªèi hay th·∫Øc m·∫Øc n√†o, ƒë·ª´ng ng·∫ßn ng·∫°i li√™n h·ªá v·ªõi m√¨nh qua Gmail. B√™n c·∫°nh ƒë√≥, n·∫øu b·∫°n mu·ªën xem l·∫°i c√°c b√†i vi·∫øt tr∆∞·ªõc ƒë√¢y c·ªßa m√¨nh, h√£y nh·∫•n v√†o hai n√∫t d∆∞·ªõi ƒë√¢y ƒë·ªÉ truy c·∫≠p trang **Rpubs** ho·∫∑c m√£ ngu·ªìn tr√™n **Github**. R·∫•t vui ƒë∆∞·ª£c ƒë·ªìng h√†nh c√πng b·∫°n, h·∫πn g·∫∑p l·∫°i! üòÑüòÑüòÑ

```{=html}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Me</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-icons@v6.0.0/svgs/rstudio.svg">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f9f9f9; }
        .container { max-width: 400px; margin: auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        label { display: block; margin: 10px 0 5px; }
        input[type="email"] { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; }
        .github-button, .rpubs-button { margin-top: 20px; text-align: center; }
        .github-button button, .rpubs-button button { background-color: #333; color: white; border: none; padding: 10px; cursor: pointer; border-radius: 4px; width: 100%; }
        .github-button button:hover, .rpubs-button button:hover { background-color: #555; }
        .rpubs-button button { background-color: #75AADB; }
        .rpubs-button button:hover { background-color: #5A9BC2; }
        .rpubs-icon { margin-right: 5px; width: 20px; vertical-align: middle; filter: brightness(0) invert(1); }
        .error-message { color: red; font-size: 0.9em; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Contact Me</h2>
        <form id="emailForm">
            <label for="email">Your Email:</label>
            <input type="email" id="email" name="email" required aria-label="Email Address">
            <div class="error-message" id="error-message" style="display: none;">Please enter a valid email address.</div>
            <button type="submit">Send Email</button>
        </form>
        <div class="github-button">
            <button>
                <a href="https://github.com/Loccx78vn/Material_Requirement_Planning" target="_blank" style="color: white; text-decoration: none;">
                    <i class="fab fa-github"></i> View Code on GitHub
                </a>
            </button>
        </div>
        <div class="rpubs-button">
            <button>
                <a href="https://rpubs.com/loccx" target="_blank" style="color: white; text-decoration: none;">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@v6.0.0/icons/rstudio.svg" alt="RStudio icon" class="rpubs-icon"> Visit my RPubs
                </a>
            </button>
        </div>
    </div>

    <script>
        document.getElementById('emailForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission
            const emailInput = document.getElementById('email');
            const email = emailInput.value;
            const errorMessage = document.getElementById('error-message');

            // Simple email validation regex
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (emailPattern.test(email)) {
                errorMessage.style.display = 'none'; // Hide error message
                const yourEmail = 'loccaoxuan103@gmail.com'; // Your email
                const gmailLink = `https://mail.google.com/mail/?view=cm&fs=1&to=${yourEmail}&su=Help%20Request%20from%20${encodeURIComponent(email)}`;
                window.open(gmailLink, '_blank'); // Open in new tab
            } else {
                errorMessage.style.display = 'block'; // Show error message
            }
        });
    </script>
</body>
</html>
```